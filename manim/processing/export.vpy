import vapoursynth as vs  # type: ignore

core = vs.core
core.std.LoadPlugin(path="C:/Users/ai/dev/visocode/manim/processing/VSFilterMod.dll")
core.std.LoadPlugin(path="C:/Users/ai/dev/visocode/manim/processing/BestSource.dll")

# file names should be changed as appropriate
video = core.bs.VideoSource(
    source="C:/Users/ai/dev/visocode/media/videos/main/1080p60/Manim_de.mp4"
)
# Ensure the ASS subtitle file is UTF-8 with BOM, as some Windows renderers expect a BOM
ass_path = "C:/Users/ai/dev/visocode/media/Manim_de.ass"
try:
    with open(ass_path, "rb") as _f:
        data = _f.read()
    # If file is valid UTF-8 but missing BOM, add BOM
    if not data.startswith(b"\xef\xbb\xbf"):
        try:
            data.decode("utf-8")
            with open(ass_path, "wb") as _f:
                _f.write(b"\xef\xbb\xbf" + data)
        except UnicodeDecodeError:
            # If not valid UTF-8, attempt to decode as cp1252 and re-encode as UTF-8 with BOM
            try:
                text = data.decode("cp1252")
                with open(ass_path, "wb") as _f:
                    _f.write(b"\xef\xbb\xbf" + text.encode("utf-8"))
            except Exception:
                # If all else fails, leave the file as-is
                pass
except Exception:
    pass

subtitled_video = core.vsfm.TextSubMod(video, ass_path)
subtitled_video.set_output()

# Paths should be changed as appropriate
# vspipe -c y4m .\manim\processing\export.vpy .\manim\processing\temp.raw
# ffmpeg -i .\manim\processing\temp.raw .\manim\processing\temp.mp4
# rm .\manim\processing\temp.raw
# ffmpeg -i .\manim\processing\temp.mp4 -i .\media\videos\main\1080p60\Manim_de.wav -c:v copy -c:a copy .\manim\processing\output_no_music.mp4
# rm .\manim\processing\temp.mp4
# ffmpeg -i .\manim\processing\output_no_music.mp4 -i '.\manim\processing\music\Moonlight Magic - Asher Fulero.mp3' -filter_complex "[1:a]volume=0.1[music];[0:a][music]amix=inputs=2:duration=first[a]" -map 0:v -map "[a]" -c:v copy -c:a aac -shortest .\manim\processing\output.mp4
# rm .\manim\processing\output_no_music.mp4
# export and send back output.mp4
# clean up:
# rm .\media -r -force
# rm .\manim\processing\output.mp4
